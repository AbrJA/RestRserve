<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exposes R Code as a Http-Service • RestRserve</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="jquery.sticky-kit.min.js"></script><script src="pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">RestRserve</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fa fa-home fa-lg"></span>

  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->


      </header><div class="row">
  <div class="contents col-md-9">

<div id="contents" class="section level2">
<h2 class="hasAnchor">
<a href="#contents" class="anchor"></a>Contents</h2>
<ul>
<li>RestRserve <a href="#create-application">Hello-world</a>
</li>
<li>Easily create <a href="#swagger-ui-and-openapi">Swagger UI and OpenAPI</a>
</li>
<li>
<a href="#deploy-application">Deployment application</a> with one line of code</li>
<li>
<a href="#stress-test">Stress test</a> - serve 20000 requests/sec from a laptop with <code>RestRserve</code>
</li>
<li><a href="#acknowledgements">Acknowledgements</a></li>
</ul>
</div>
<div id="restrserve" class="section level2">
<h2 class="hasAnchor">
<a href="#restrserve" class="anchor"></a>RestRserve</h2>
<p><strong>RestRserve</strong> is a <strong>concurrent high-performance http-server for R applications</strong>.</p>
<p>It could handle about <strong><a href="#stress-test">20000 simple requests per second</a></strong> on my macbook laptop with intel i7-7820HQ CPU, 4 cores / 8 threads (~ 40x faster than <a href="https://github.com/trestletech/plumber">plumber</a> which can use only 1 thread).</p>
<p>All credits should go to <a href="https://github.com/s-u">Simon Urbanek</a> - RestRserve is a very thin layer on the top of <a href="https://github.com/s-u/Rserve">Rserve</a>.</p>
<p>The main contribution of the RestRserve is a set of functions for convenient registering endpoints and deployment of applications. Also we will try to provide more detailed documentation.</p>
<div id="create-application" class="section level3">
<h3 class="hasAnchor">
<a href="#create-application" class="anchor"></a>Create application</h3>
<p>Creating application is very simple. For example let’s create endpoint which will caclulate <a href="https://en.wikipedia.org/wiki/Fibonacci_number">Fibonacci number</a> for us:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">calc_fib =<span class="st"> </span><span class="cf">function</span>(n) {
  <span class="cf">if</span>(n <span class="op">&lt;</span><span class="st"> </span>0L) <span class="kw">stop</span>(<span class="st">"n should be &gt;= 0"</span>)
  <span class="cf">if</span>(n <span class="op">==</span><span class="st"> </span>0L) <span class="kw">return</span>(0L)
  <span class="cf">if</span>(n <span class="op">==</span><span class="st"> </span>1L <span class="op">||</span><span class="st"> </span>n <span class="op">==</span><span class="st"> </span>2L) <span class="kw">return</span>(1L)

  x =<span class="st"> </span><span class="kw">rep</span>(1L, n)
  <span class="cf">for</span>(i <span class="cf">in</span> 3L<span class="op">:</span>n)
    x[[i]] =<span class="st"> </span>x[[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>]] <span class="op">+</span><span class="st"> </span>x[[i <span class="op">-</span><span class="st"> </span><span class="dv">2</span>]]

  x[[n]]
}

fib =<span class="st"> </span><span class="cf">function</span>(request) {
  <span class="kw">try</span>({n =<span class="st"> </span><span class="kw">as.integer</span>( request<span class="op">$</span>query[[<span class="st">"n"</span>]] )}, <span class="dt">silent =</span> <span class="ot">TRUE</span>)

  <span class="cf">if</span>((<span class="kw">class</span>(n) <span class="op">==</span><span class="st"> "try-error"</span>) <span class="op">||</span><span class="st"> </span><span class="kw">length</span>(request<span class="op">$</span>query) <span class="op">!=</span><span class="st"> </span>1L)
    <span class="kw">stop</span>(<span class="st">"request should look like 'n=5'"</span>)

  RestRserve<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/RestRserve/topics/create_response">create_response</a></span>(<span class="dt">payload =</span> <span class="kw">as.character</span>(<span class="kw">calc_fib</span>(n)), <span class="dt">content_type =</span> <span class="st">"text/plain"</span>,
                              <span class="dt">headers =</span> <span class="kw">character</span>(<span class="dv">0</span>), <span class="dt">status_code =</span> 200L)
}

<span class="co"># create application</span>
app =<span class="st"> </span>RestRserve<span class="op">::</span>RestRserveApplication<span class="op">$</span><span class="kw">new</span>()
<span class="co"># register endpoints and corresponding R handlers</span>
app<span class="op">$</span><span class="kw">add_route</span>(<span class="dt">path =</span> <span class="st">"/fib"</span>, <span class="dt">method =</span> <span class="st">"GET"</span>, <span class="dt">FUN =</span> fib)</code></pre></div>
<p>Note that every user function which is registered as endpoint handler should <strong>ALWAYS return ‘RestRserveResponse’ object</strong> which is easy to construct with <code><a href="http://www.rdocumentation.org/packages/RestRserve/topics/create_response">RestRserve::create_response</a></code> (essentially a <code>list</code> with particular fields) .</p>
</div>
<div id="start-application-in-interactive-mode" class="section level3">
<h3 class="hasAnchor">
<a href="#start-application-in-interactive-mode" class="anchor"></a>Start application in interactive mode</h3>
<p><strong>Start</strong> application from interactive session with following command:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">app<span class="op">$</span><span class="kw">run</span>(<span class="dt">port =</span> <span class="st">"8001"</span>)</code></pre></div>
<p>This turns the current R session into Rserve session. Rserve takes over until it is shut down or receives a user interrupt signal.</p>
<p>Please note that if you launch it from Rstudio, then your Rstudio session will be blocked (<code>Ctrl+C</code> will not work). So to exit you will need to kill Rserve manually - just type <code>kill PID</code> from terminal. PID of the Rserve will be printed to the console after application start.</p>
<p><strong>Test it works</strong>:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">curl</span> http://localhost:8001/fib?n=10
<span class="co"># 55</span></code></pre></div>
</div>
<div id="swagger-ui-and-openapi" class="section level3">
<h3 class="hasAnchor">
<a href="#swagger-ui-and-openapi" class="anchor"></a>Swagger UI and OpenAPI</h3>
<p>Optionally RestRserve can generate <a href="https://www.openapis.org/">OpenAPI</a> document according to the <a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.1.md">specification</a>. You just need to provide docstringings in YAML format in your functions:</p>
<ol>
<li>OpenAPI definition block should start and end with <code>#' ---</code> (at least 3 <code>-</code> after <code>#'</code>)</li>
<li>Definition should be valid YAML according to the <a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.1.md">specification</a>.</li>
<li>Each line in YAML starts with <code>#'</code> - mind whitespace after roxygen2-style comment start <code>#'</code>
</li>
<li>For customization see <code>app$add_openapi()</code> method arguments and <code>openapi_*()</code> family of functions (not all constructors for OpenAPI objects are fully implemented - contributions are very welcome).</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fib =<span class="st"> </span><span class="cf">function</span>(request) {

  <span class="co">#' ---</span>
  <span class="co">#' description: Calculates Fibonacci number</span>
  <span class="co">#' parameters:</span>
  <span class="co">#'   - name: "n"</span>
  <span class="co">#'     description: "x for Fibonnacci number"</span>
  <span class="co">#'     in: query</span>
  <span class="co">#'     schema:</span>
  <span class="co">#'       type: integer</span>
  <span class="co">#'     example: 10</span>
  <span class="co">#'     required: true</span>
  <span class="co">#' responses:</span>
  <span class="co">#'   200:</span>
  <span class="co">#'     description: API response</span>
  <span class="co">#'     content:</span>
  <span class="co">#'       text/plain:</span>
  <span class="co">#'         schema:</span>
  <span class="co">#'           type: string</span>
  <span class="co">#'           example: 5</span>
  <span class="co">#' ---</span>

  <span class="kw">try</span>({n =<span class="st"> </span><span class="kw">as.integer</span>( request<span class="op">$</span>query[[<span class="st">"n"</span>]] )}, <span class="dt">silent =</span> <span class="ot">TRUE</span>)

  <span class="cf">if</span>((<span class="kw">class</span>(n) <span class="op">==</span><span class="st"> "try-error"</span>) <span class="op">||</span><span class="st"> </span><span class="kw">length</span>(request<span class="op">$</span>query) <span class="op">!=</span><span class="st"> </span>1L)
    <span class="kw">stop</span>(<span class="st">"request should look like 'n=5'"</span>)

  RestRserve<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/RestRserve/topics/create_response">create_response</a></span>(<span class="dt">payload =</span> <span class="kw">as.character</span>(<span class="kw">calc_fib</span>(n)), <span class="dt">content_type =</span> <span class="st">"text/plain"</span>,
                              <span class="dt">headers =</span> <span class="kw">character</span>(<span class="dv">0</span>), <span class="dt">status_code =</span> 200L)
}

app =<span class="st"> </span>RestRserve<span class="op">::</span>RestRserveApplication<span class="op">$</span><span class="kw">new</span>()
app<span class="op">$</span><span class="kw">add_route</span>(<span class="dt">path =</span> <span class="st">"/fib"</span>, <span class="dt">method =</span> <span class="st">"GET"</span>, <span class="dt">FUN =</span> fib)
app<span class="op">$</span><span class="kw">add_openapi</span>()
app<span class="op">$</span><span class="kw">add_swagger_ui</span>()
app<span class="op">$</span><span class="kw">run</span>(<span class="dt">port =</span> <span class="st">"8001"</span>)</code></pre></div>
<p><img src="swagger-ui.png" alt="swagger-ui"></p>
</div>
<div id="deploy-application" class="section level3">
<h3 class="hasAnchor">
<a href="#deploy-application" class="anchor"></a>Deploy application</h3>
<p><strong>Recommended way</strong> to serve application (file with R code) is to deploy it to some directory and start service in daemon mode.</p>
<p>There is only one simple <strong>RULE</strong> for application - it should have a <strong>‘RestRserveApp’ object in global environment</strong> and it should inherit from <code><a href="http://www.rdocumentation.org/packages/RestRserve/topics/RestRserveApplication">RestRserve::RestRserveApplication</a></code>.</p>
<p>Deploying is as simple as:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># fib.R</span>
configuration =<span class="st"> </span><span class="kw">c</span>(<span class="st">"http.port"</span> =<span class="st"> "8001"</span>,
                  <span class="st">"encoding"</span> =<span class="st"> "utf8"</span>,
                  <span class="st">"port"</span> =<span class="st"> "6311"</span>)

<span class="co"># specify directory where to depliy application </span>
dir =<span class="st"> </span><span class="kw">tempdir</span>()

<span class="co"># specify path to user application</span>
app_path =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"fib.R"</span>, <span class="dt">package =</span> <span class="st">"RestRserve"</span>)

<span class="co"># Here it is a path to "fib.R" demo application built in into the package</span>
<span class="co"># For example on my machine it is here:</span>
<span class="co"># "/usr/local/lib/R/3.4/site-library/RestRserve/fib.R"</span>
<span class="co"># also you can check it online:</span>
<span class="co"># https://github.com/dselivanov/RestRserve/blob/master/inst/fib.R</span>

RestRserve<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/RestRserve/topics/restrserve_deploy">restrserve_deploy</a></span>(<span class="dt">file =</span> app_path, <span class="dt">dir =</span> dir, <span class="dt">configuration =</span> configuration)</code></pre></div>
<p>This will generate Rserve configuration file (<code>Rserve.conf</code>) and put it along with a copy of the user application to the application directory <code>dir</code> (in our example <code>current_app_snapshot</code> is a copy of <code>/usr/local/lib/R/3.4/site-library/RestRserve/fib.R</code>):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">list.files</span>(dir)
<span class="co">#"current_app_snapshot" "Rserve.conf" </span></code></pre></div>
<p>Note that by default <code>current_app_snapshot</code> will be used when service is starting. Keep in mind this when you specify filepaths in your code. It is possible to force to use original file - see <code>start_from_snapshot</code> argument of the <code><a href="reference/restrserve_deploy.html">restrserve_deploy()</a></code> function.</p>
</div>
<div id="start-application" class="section level3">
<h3 class="hasAnchor">
<a href="#start-application" class="anchor"></a>Start application</h3>
<p><code><a href="reference/restrserve_start.html">restrserve_start()</a></code> starts service in daemon mode. It returns named integer:</p>
<ul>
<li>path to the file where this pid is stored as a name</li>
<li>pid of the application as a value</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">PID =<span class="st"> </span>RestRserve<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/RestRserve/topics/restrserve_start">restrserve_start</a></span>(dir)
PID
<span class="co">#/Users/dmitry/RestRserveFib/Rserve.pid </span>
<span class="co">#                                  67439</span></code></pre></div>
<p><strong>Test it works</strong></p>
<p>Send request to existing <code>/fib</code> endpoint :</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">curl</span> -sD - localhost:8001/fib?n=10</code></pre></div>
<pre class="text"><code>HTTP/1.1 200 OK
Content-type: text/plain
Content-length: 16

n=5</code></pre>
<p><strong>Test it handles requests to non-existing endpoints</strong></p>
<p>Send request to non-existing <code>/incorrectmethod</code> endpoint:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">curl</span> -sD - localhost:8001/incorrectmethod?n=10</code></pre></div>
<pre class="text"><code>HTTP/1.1 404 Code 404
Content-type: text/plain
Content-length: 41

Resource '/incorrectmethod' doesn't exist</code></pre>
</div>
<div id="stress-test" class="section level3">
<h3 class="hasAnchor">
<a href="#stress-test" class="anchor"></a>Stress test</h3>
<p>Load testing with <a href="https://github.com/apigee/apib">apib: API Bench</a>:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">apib</span> -c 16 -d 10 http://127.0.0.1:8001/fib?n=5</code></pre></div>
<pre class="txt"><code>(5 / 10) 19310.240 0% cpu
(10 / 10) 19098.729 0% cpu
Duration:             10.009 seconds
Attempted requests:   192220
Successful requests:  192220
Non-200 results:      0
Connections opened:   16
Socket errors:        0

Throughput:           19204.666 requests/second
Average latency:      0.832 milliseconds
Minimum latency:      0.312 milliseconds
Maximum latency:      165.797 milliseconds
Latency std. dev:     1.851 milliseconds
50% latency:          0.709 milliseconds
90% latency:          1.081 milliseconds
98% latency:          2.012 milliseconds
99% latency:          2.774 milliseconds

Client CPU average:    0%
Client CPU max:        0%
Client memory usage:    0%

Total bytes sent:      12.65 megabytes
Total bytes received:  11.92 megabytes
Send bandwidth:        10.11 megabits / second
Receive bandwidth:     9.52 megabits / second</code></pre>
</div>
<div id="stop-application" class="section level3">
<h3 class="hasAnchor">
<a href="#stop-application" class="anchor"></a>Stop application</h3>
<p>Stop particular application (with all the childs):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="reference/restrserve_stop.html">restrserve_stop</a></span>(dir)</code></pre></div>
</div>
</div>
<div id="acknowledgements" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#acknowledgements" class="anchor"></a>Acknowledgements</h1></div>
<ul>
<li>
<a href="https://github.com/s-u/">Simon Urbanek</a> (@s-u) for awesome <a href="https://github.com/s-u/Rserve">Rserve</a> and all the work on R itself and on his other packages</li>
<li>
<a href="https://github.com/trestletech">Jeff Allen</a> (@trestletech) for <a href="https://github.com/trestletech/plumber">plumber</a>. We borrowed code snippet for swagger-ui adjusment</li>
<li>
<a href="https://github.com/artemklevtsov">Artem Klevtsov</a> (@artemklevtsov) for useful comments</li>
</ul>
</div>

  </div>

  <div class="col-md-3" id="sidebar">
    <h2>License</h2>
<p>GPL (&gt;= 2)</p>
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Dmitriy Selivanov <br><small class="roles"> Author, maintainer </small> </li>
</ul>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Dmitriy Selivanov.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
